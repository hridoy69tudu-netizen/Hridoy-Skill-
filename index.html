<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>CashReward App</title>

  <script src='//libtl.com/sdk.js' data-zone='9476147' data-sdk='show_9476147'></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root { --accent: #4a90e2; }
    body { font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto; background: #0d0d0d; color: #eaeaea; }
    .card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 1.25rem; box-shadow: 0 6px 24px rgba(0,0,0,.35); }
    .input { background: #242424; border: 1px solid #3a3a3a; color: #fff; border-radius: .9rem; padding: .9rem; }
    .input::placeholder { color: #9aa0a6; }
    .btn { border-radius: .9rem; padding: .9rem 1rem; font-weight: 700; transition: .2s; }
    .btn:active { transform: scale(.98); }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-accent:hover { filter: brightness(.95); }
    .btn-outline { border: 1px solid var(--accent); color: var(--accent); background: transparent; }
    .btn-outline:hover { background: var(--accent); color: #fff; }
    .page { display: none; animation: fade .25s ease; }
    .page.active { display: block; }
    .nav { position: fixed; left: 0; right: 0; bottom: 0; background: #111; border-top: 1px solid #2a2a2a; display: flex; justify-content: space-around; padding: .6rem .25rem; z-index: 50; }
    .nav a { display: flex; flex-direction: column; align-items: center; gap: .15rem; color: #9aa0a6; font-size: .8rem; }
    .nav a.active { color: var(--accent); }
    @keyframes fade { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

<div id="loader" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="h-16 w-16 rounded-full border-4 border-white/20 border-t-[color:var(--accent)] animate-spin"></div>
</div>

<section id="auth" class="min-h-screen flex items-center justify-center p-6">
  <div class="card w-full max-w-md p-6">
    <h1 class="text-3xl font-bold text-center mb-2">CashReward</h1>
    <p id="authTitle" class="text-center text-gray-400 mb-6">Login to your account</p>

    <div id="loginForm" class="space-y-4">
      <input id="loginEmail" type="email" placeholder="Email" class="input w-full">
      <input id="loginPass" type="password" placeholder="Password" class="input w-full">
      <button id="loginBtn" class="btn btn-accent w-full">Login</button>
      <button id="toRegister" class="btn btn-outline w-full">Don't have an account? Register</button>
    </div>

    <div id="registerForm" class="hidden space-y-4">
      <input id="regName" type="text" placeholder="Full Name" class="input w-full">
      <input id="regEmail" type="email" placeholder="Email" class="input w-full">
      <input id="regPass" type="password" placeholder="Password" class="input w-full">
      <input id="regRef" type="text" placeholder="Referral Code (Optional)" class="input w-full">
      <button id="registerBtn" class="btn btn-accent w-full">Create Account</button>
      <button id="toLogin" class="btn btn-outline w-full">Already have an account? Login</button>
    </div>
  </div>
</section>

<section id="app" class="hidden min-h-screen flex flex-col">
  <header class="p-4 bg-[#141414] border-b border-[#262626] flex items-center justify-between">
    <div class="flex items-center gap-3">
      <i data-lucide="badge-dollar-sign" class="w-6 h-6"></i>
      <div>
        <p id="userName" class="font-semibold leading-5">User</p>
        <p id="userEmail" class="text-xs text-gray-400 leading-3"></p>
      </div>
    </div>
    <button id="logoutBtn" class="text-red-400 text-sm">Logout</button>
  </header>

  <main class="p-4 pb-24 space-y-6">

    <div id="home" class="page active">
      <div class="card p-5">
        <p class="text-gray-400">Current Balance</p>
        <p class="text-4xl font-extrabold mt-1">à§³<span id="balance">0.00</span></p>
        <p class="text-sm text-gray-500 mt-1">Earning per ad: à§³<span id="perAd">0.00</span></p>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="card p-5 text-center">
          <i data-lucide="play" class="w-10 h-10 mx-auto mb-2"></i>
          <p class="font-semibold mb-3">Watch Ads</p>
          <button id="watchAdBtn" class="btn btn-accent w-full">Watch & Earn</button>
          <p id="adsToday" class="text-xs text-gray-400 mt-2"></p>
        </div>

        <div class="card p-5 text-center">
          <i data-lucide="gift" class="w-10 h-10 mx-auto mb-2"></i>
          <p class="font-semibold mb-3">Daily Bonus</p>
          <button id="dailyBonusBtn" class="btn btn-outline w-full">Claim Bonus</button>
          <p id="bonusNote" class="text-xs text-gray-400 mt-2"></p>
        </div>
      </div>
    </div>

    <div id="tasks" class="page">
      <h3 class="text-xl font-bold mb-3">Other Tasks</h3>
      <div class="card p-5">
        <div class="flex items-center gap-3">
          <i data-lucide="globe" class="w-6 h-6 text-emerald-400"></i>
          <div class="flex-1">
            <p class="font-semibold">Web Visit</p>
            <p class="text-sm text-gray-400">Coming soon</p>
          </div>
          <button class="btn btn-accent px-4 py-2" disabled>Open</button>
        </div>
      </div>
      <div class="card p-5 mt-4">
        <div class="flex items-center gap-3">
          <i data-lucide="send" class="w-6 h-6 text-fuchsia-400"></i>
          <div class="flex-1">
            <p class="font-semibold">Telegram Income</p>
            <p class="text-sm text-gray-400">Coming soon</p>
          </div>
          <button class="btn btn-accent px-4 py-2" disabled>Open</button>
        </div>
      </div>
    </div>

    <div id="withdraw" class="page">
      <h3 class="text-xl font-bold mb-3">Withdraw Coins</h3>
      <div class="card p-5 space-y-4">
        <p id="minWText" class="text-center text-gray-400"></p>
        <div>
          <label class="text-sm text-gray-400">Method</label>
          <select id="wMethod" class="input w-full mt-1"></select>
        </div>
        <div>
          <label class="text-sm text-gray-400">Amount (Coins)</label>
          <input id="wAmount" type="number" placeholder="Enter amount" class="input w-full mt-1">
        </div>
        <div>
          <label class="text-sm text-gray-400">Payment Detail (e.g., Phone Number)</label>
          <input id="wDetail" type="text" placeholder="Number" class="input w-full mt-1">
        </div>
        <button id="withdrawBtn" class="btn btn-accent w-full">Request Withdrawal</button>
      </div>
    </div>

    <div id="refer" class="page">
      <h3 class="text-xl font-bold mb-3">Refer & Earn</h3>
      <div class="card p-5 text-center">
        <p class="text-gray-400 mb-2">Share your code & earn</p>
        <p id="refCode" class="text-3xl font-bold text-[color:var(--accent)] mb-3"></p>
        <button id="copyRef" class="btn btn-outline">Copy Code</button>
      </div>
    </div>

    <div id="history" class="page">
      <h3 class="text-xl font-bold mb-3">Transaction History</h3>
      <div id="historyList" class="space-y-3"></div>
    </div>

    <div id="notif" class="page">
      <h3 class="text-xl font-bold mb-3">Notifications</h3>
      <div id="notifList" class="space-y-3"></div>
    </div>

    <div id="settings" class="page">
      <h3 class="text-xl font-bold mb-3">Settings</h3>
      <div class="card p-5 space-y-4">
        <div>
          <label class="text-sm text-gray-400">Display Name</label>
          <input id="setName" type="text" placeholder="Your name" class="input w-full mt-1">
        </div>
        <button id="saveProfile" class="btn btn-accent w-full">Save Changes</button>
        <button id="logoutBtn2" class="btn btn-outline w-full">Logout</button>

        <div class="grid grid-cols-2 gap-4 pt-4">
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-[color:var(--accent)]" id="statRef">0</p>
            <p class="text-sm text-gray-400">Total Referrals</p>
          </div>
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-[color:var(--accent)]" id="statWd">0</p>
            <p class="text-sm text-gray-400">Total Withdrawals</p>
          </div>
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-[color:var(--accent)]" id="statTasks">0</p>
            <p class="text-sm text-gray-400">Total Tasks</p>
          </div>
          <div class="card p-4 text-center">
            <p class="text-2xl font-bold text-[color:var(--accent)]" id="statAds">0</p>
            <p class="text-sm text-gray-400">Total Ads</p>
          </div>
        </div>
      </div>
    </div>

  </main>

  <nav class="nav">
    <a data-page="home" class="active"><i data-lucide="home" class="w-6 h-6"></i><span>Home</span></a>
    <a data-page="tasks"><i data-lucide="list-checks" class="w-6 h-6"></i><span>Tasks</span></a>
    <a data-page="withdraw"><i data-lucide="briefcase" class="w-6 h-6"></i><span>Wallet</span></a>
    <a data-page="notif"><i data-lucide="megaphone" class="w-6 h-6"></i><span>Alert</span></a>
    <a data-page="refer"><i data-lucide="user-plus" class="w-6 h-6"></i><span>Refer</span></a>
    <a data-page="history"><i data-lucide="clock" class="w-6 h-6"></i><span>History</span></a>
    <a data-page="settings"><i data-lucide="settings" class="w-6 h-6"></i><span>Settings</span></a>
  </nav>
</section>

<div id="alert" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
  <div class="card w-full max-w-sm p-5 text-center">
    <p id="alertMsg" class="mb-4"></p>
    <button id="alertOk" class="btn btn-accent">OK</button>
  </div>
</div>

<script type="module">
  // SECURITY REMINDER: Protect your Firestore rules!
  const firebaseConfig = {
    apiKey: "AIzaSyAuRjoQd88a3sRaU-mZyogapNCjgDbc4R8",
    authDomain: "hridoy-skill-1.firebaseapp.com",
    databaseURL: "https://hridoy-skill-1-default-rtdb.firebaseio.com",
    projectId: "hridoy-skill-1",
    storageBucket: "hridoy-skill-1.firebasestorage.app",
    messagingSenderId: "840073498608",
    appId: "1:840073498608:web:4741e43ca186e027a95735",
    measurementId: "G-YG5H5ZFBR8"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, orderBy, where, serverTimestamp, addDoc, limit, runTransaction } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // State
  let user = null;
  let userData = null;
  let appConfig = null;
  const today = () => new Date().toISOString().slice(0,10);

  // UI helpers
  const $ = (id)=>document.getElementById(id);
  const show = (el)=>el.classList.remove("hidden");
  const hide = (el)=>el.classList.add("hidden");
  const showLoader=()=>show($("loader"));
  const hideLoader=()=>hide($("loader"));
  const alertBox = $("alert"); const alertMsg=$("alertMsg");
  $("alertOk").onclick = ()=>hide(alertBox);
  const notify = (msg)=>{ alertMsg.textContent=msg; show(alertBox); };

  // Nav
  document.querySelectorAll(".nav a").forEach(a=>{
    a.addEventListener("click",(e)=>{
      e.preventDefault();
      const page = a.dataset.page;
      document.querySelectorAll(".nav a").forEach(n=>n.classList.remove("active"));
      a.classList.add("active");
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      $(page).classList.add("active");
      if(page==="history") loadHistory();
      if(page==="notif") loadNotifications();
      if(page==="settings") { $("setName").value = userData?.name || ""; }
    });
  });

  // Icons
  window.onload = ()=>{ if(window.lucide){ window.lucide.createIcons(); } };

  // Auth state
  onAuthStateChanged(auth, async (u)=>{
    if(u){
      user=u;
      hide($("auth"));
      show($("app"));
      await bootstrap();
    }else{
      user=null; userData=null;
      show($("auth"));
      hide($("app"));
    }
  });

  // Bootstrap user + config
  async function bootstrap(){
    try{
      showLoader();
      // Load config
      const cRef = doc(db,"config","main");
      const cSnap = await getDoc(cRef);
      appConfig = cSnap.exists() ? cSnap.data() : { dailyAdLimit:0, minWithdrawal:0, paymentMethods:[], rewards:{monetag:0,dailyBonus:0,referral:0} };

      // Load user doc
      const uRef = doc(db,"users", user.uid);
      const uSnap = await getDoc(uRef);
      if(!uSnap.exists()){
        await setDoc(uRef,{
          uid:user.uid, email:user.email || "",
          name: user.email?.split("@")[0] || "User",
          balance:0, dailyAdCount:0, lastAdWatchDate:"",
          isBlocked:false, totalAdsWatched:0,
          totalReferrals:0, totalWithdrawals:0,
          referralCode: user.uid.slice(0,10),
          lastBonusDate:""
        });
        userData = (await getDoc(uRef)).data();
      } else {
        userData = uSnap.data();
      }

      if(userData.isBlocked){ notify("Your account has been blocked."); await signOut(auth); return; }

      // UI
      $("userName").textContent = userData.name || "User";
      $("userEmail").textContent = userData.email || user.email || "";
      $("refCode").textContent = userData.referralCode || user.uid.slice(0,10);
      $("perAd").textContent = (appConfig.rewards?.monetag||0).toFixed(2);
      $("minWText").textContent = `Minimum withdrawal amount: ${appConfig.minWithdrawal||0} coins`;
      $("balance").textContent = (userData.balance||0).toFixed(2);
      $("adsToday").textContent = `Ads today: ${userData.lastAdWatchDate===today()? (userData.dailyAdCount||0):0}/${appConfig.dailyAdLimit||0}`;
      $("bonusNote").textContent = userData.lastBonusDate===today() ? "Already claimed today" : `Bonus today: à§³${(appConfig.rewards?.dailyBonus||0).toFixed(2)}`;

      // Stats
      $("statRef").textContent = userData.totalReferrals||0;
      $("statWd").textContent = userData.totalWithdrawals||0;
      $("statTasks").textContent = userData.totalAdsWatched||0;
      $("statAds").textContent = userData.totalAdsWatched||0;

      // Withdraw methods
      const wSel = $("wMethod"); wSel.innerHTML="";
      (appConfig.paymentMethods||[]).forEach(m=>{
        const opt=document.createElement("option"); opt.value=m; opt.textContent=m; wSel.appendChild(opt);
      });
    }catch(e){
      console.error(e); notify("Failed to load data.");
    }finally{
      hideLoader();
    }
  }

  // Auth actions
  $("loginBtn").onclick = async ()=>{
    const email=$("loginEmail").value.trim();
    const pass=$("loginPass").value;
    if(!email||!pass) return notify("Enter email & password");
    try{ showLoader(); await signInWithEmailAndPassword(auth,email,pass); }
    catch(e){ notify("Login failed: "+e.message); }
    finally{ hideLoader(); }
  };

  $("registerBtn").onclick = async ()=>{
    const name=$("regName").value.trim();
    const email=$("regEmail").value.trim();
    const pass=$("regPass").value;
    const refCode=$("regRef").value.trim();
    if(!name||!email||!pass) return notify("Fill all required fields");
    try{
      showLoader();
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      const u=cred.user;
      const referralCode = u.uid.slice(0,10);

      // Handle referral logic within a transaction to ensure atomicity
      await runTransaction(db, async (transaction) => {
          let referrerDocRef = null;
          let referrerData = null;
          if (refCode) {
              const q = query(collection(db, "users"), where("referralCode", "==", refCode), limit(1));
              const querySnapshot = await getDocs(q);
              if (!querySnapshot.empty) {
                  referrerDocRef = querySnapshot.docs[0].ref;
                  referrerData = querySnapshot.docs[0].data();
                  // Update referrer's balance and referral count
                  transaction.update(referrerDocRef, {
                      balance: (referrerData.balance || 0) + (appConfig.rewards?.referral || 0),
                      totalReferrals: (referrerData.totalReferrals || 0) + 1
                  });
              }
          }

          // Create new user document
          transaction.set(doc(db, "users", u.uid), {
              uid: u.uid,
              email,
              name,
              balance: (refCode && referrerData) ? (appConfig.rewards?.referral || 0) : 0, // Reward new user if referred
              dailyAdCount: 0,
              lastAdWatchDate: "",
              isBlocked: false,
              totalAdsWatched: 0,
              referredBy: refCode || null,
              createdAt: serverTimestamp(),
              totalReferrals: 0,
              totalWithdrawals: 0,
              referralCode
          });
      });

      notify("Registration successful! Referral bonus applied.");
    } catch(e) {
      notify("Registration failed: " + e.message);
    } finally {
      hideLoader();
    }
  };

  $("toRegister").onclick = ()=>{
    $("loginForm").classList.add("hidden");
    $("registerForm").classList.remove("hidden");
    $("authTitle").textContent="Create a new account";
  };
  $("toLogin").onclick = ()=>{
    $("registerForm").classList.add("hidden");
    $("loginForm").classList.remove("hidden");
    $("authTitle").textContent="Login to your account";
  };

  // Profile save
  $("saveProfile").onclick = async ()=>{
    const newName=$("setName").value.trim();
    if(!newName) return notify("Enter a name");
    try{
      showLoader();
      await updateDoc(doc(db,"users",user.uid),{ name:newName });
      userData.name=newName;
      $("userName").textContent=newName;
      notify("Profile updated");
    }catch(e){ notify("Update failed"); }
    finally{ hideLoader(); }
  };

  // Logout
  $("logoutBtn").onclick = ()=>signOut(auth);
  $("logoutBtn2").onclick = ()=>signOut(auth);

  // Copy referral
  $("copyRef").onclick = ()=>{
    navigator.clipboard.writeText($("refCode").textContent);
    notify("Referral code copied!");
  };

  // Watch Ad + reward
  $("watchAdBtn").onclick = async ()=>{
    if(!appConfig) return notify("Config not loaded yet");
    const limit = appConfig.dailyAdLimit||0;
    const countToday = (userData.lastAdWatchDate===today()) ? (userData.dailyAdCount||0) : 0;
    if(countToday>=limit) return notify("You reached daily ad limit. Try tomorrow.");

    if(typeof window.show_9476147!=="function") return notify("Ad is loading, try again in a moment.");

    notify("Loading ad, please wait...");
    hide($("alert"));

    try{
      await window.show_9476147({ type:"rewarded-interstitial" });
      const reward = appConfig.rewards?.monetag||0;
      const uRef = doc(db,"users",user.uid);
      const newCount = countToday+1;

      await updateDoc(uRef,{
        balance:(userData.balance||0)+reward,
        dailyAdCount:newCount,
        lastAdWatchDate:today(),
        totalAdsWatched:(userData.totalAdsWatched||0)+1
      });

      // log transaction
      await addDoc(collection(db,"transactions"),{
        userId:user.uid,type:"ad_reward", amount:reward, createdAt:serverTimestamp()
      });

      // local state update
      userData.balance += reward;
      userData.dailyAdCount = newCount;
      userData.lastAdWatchDate = today();
      userData.totalAdsWatched = (userData.totalAdsWatched||0)+1;

      // UI
      $("balance").textContent = (userData.balance||0).toFixed(2);
      $("adsToday").textContent = `Ads today: ${newCount}/${limit}`;
      $("statAds").textContent = userData.totalAdsWatched||0;
      $("statTasks").textContent = userData.totalAdsWatched||0;

      notify(`ðŸŽ‰ You earned à§³${reward.toFixed(2)}`);
    }catch(e){
      console.warn("Ad canceled/failed", e);
      notify("Ad failed or skipped.");
    }
  };

  // Daily bonus
  $("dailyBonusBtn").onclick = async ()=>{
    if(!appConfig) return notify("Config not loaded yet");
    const already = userData.lastBonusDate===today();
    if(already) return notify("Already claimed today.");
    const bonus = appConfig.rewards?.dailyBonus||0;
    try{
      showLoader();
      await updateDoc(doc(db,"users",user.uid),{
        balance:(userData.balance||0)+bonus,
        lastBonusDate:today()
      });
      await addDoc(collection(db,"transactions"),{
        userId:user.uid, type:"daily_bonus", amount:bonus, createdAt:serverTimestamp()
      });
      userData.balance += bonus;
      userData.lastBonusDate = today();
      $("balance").textContent=(userData.balance||0).toFixed(2);
      $("bonusNote").textContent="Already claimed today";
      notify(`âœ… Daily bonus added: à§³${bonus.toFixed(2)}`);
    }catch(e){ notify("Bonus failed. Try again."); }
    finally{ hideLoader(); }
  };

  // Withdraw
  $("withdrawBtn").onclick = async ()=>{
    const amount = parseFloat($("wAmount").value);
    const method = $("wMethod").value;
    const detail = $("wDetail").value.trim();
    if(isNaN(amount)||amount<=0||!method||!detail) return notify("Fill all withdraw fields correctly.");
    if(amount > (userData.balance||0)) return notify("Not enough coins.");
    if(amount < (appConfig.minWithdrawal||0)) return notify(`Minimum withdrawal is ${appConfig.minWithdrawal} coins.`);

    try{
      showLoader();
      // Deduct
      await updateDoc(doc(db,"users",user.uid),{
        balance:(userData.balance||0)-amount,
        totalWithdrawals:(userData.totalWithdrawals||0)+1
      });
      // Log withdrawal request
      await addDoc(collection(db,"withdrawals"),{
        userId:user.uid, userName:userData.name, userEmail:userData.email,
        amount, method, paymentDetail:detail, status:"pending", requestedAt:serverTimestamp()
      });
      // Transactions feed
      await addDoc(collection(db,"transactions"),{
        userId:user.uid,type:"withdraw_request",amount:-amount,method,createdAt:serverTimestamp()
      });

      // Local + UI
      userData.balance -= amount;
      userData.totalWithdrawals = (userData.totalWithdrawals||0)+1;
      $("balance").textContent=(userData.balance||0).toFixed(2);
      $("statWd").textContent=userData.totalWithdrawals||0;
      $("wAmount").value=""; $("wDetail").value="";
      notify("Withdrawal request submitted âœ…");
    }catch(e){
      console.error(e); notify("Failed to submit withdrawal.");
    }finally{
      hideLoader();
    }
  };

  // History (merged: transactions + withdrawals)
  async function loadHistory(){
    const list = $("historyList");
    list.innerHTML = `<div class="text-center text-gray-400">Loading...</div>`;
    try{
      const txQ = query(collection(db,"transactions"), where("userId","==",user.uid), orderBy("createdAt","desc"), limit(50));
      const txSnap = await getDocs(txQ);

      const wdQ = query(collection(db,"withdrawals"), where("userId","==",user.uid), orderBy("requestedAt","desc"), limit(50));
      const wdSnap = await getDocs(wdQ);

      const items = [];

      txSnap.forEach(d=>{
        const x=d.data();
        items.push({
          t: x.createdAt?.seconds ? new Date(x.createdAt.seconds*1000) : new Date(),
          title: x.type==="ad_reward" ? "Ad Reward" : (x.type==="daily_bonus" ? "Daily Bonus" : "Withdraw Request"),
          subtitle: x.method ? `Method: ${x.method}` : "",
          amount: x.amount
        });
      });

      wdSnap.forEach(d=>{
        const x=d.data();
        items.push({
          t: x.requestedAt?.seconds ? new Date(x.requestedAt.seconds*1000) : new Date(),
          title: `Withdrawal ${x.status?.toUpperCase()||""}`,
          subtitle: `${x.method} â€¢ ${x.paymentDetail||""}`,
          amount: -Math.abs(x.amount||0)
        });
      });

      items.sort((a,b)=>b.t-a.t);

      if(items.length===0){
        list.innerHTML = `<div class="text-center text-gray-400">No history found.</div>`;
        return;
      }

      list.innerHTML = "";
      items.forEach(it=>{
        const color = it.amount>=0 ? "text-emerald-400" : "text-rose-400";
        const sign = it.amount>=0 ? "+" : "";
        const div = document.createElement("div");
        div.className="card p-4 flex items-center justify-between";
        div.innerHTML = `
          <div>
            <p class="font-semibold">${it.title}</p>
            <p class="text-xs text-gray-400">${it.subtitle||""}</p>
            <p class="text-[11px] text-gray-500 mt-1">${it.t.toLocaleString()}</p>
          </div>
          <div class="text-right">
            <p class="font-bold ${color}">${sign}${it.amount.toFixed(2)}</p>
          </div>
        `;
        list.appendChild(div);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = `<div class="text-center text-rose-400">Failed to load history.</div>`;
    }
  }

  // Notifications
  async function loadNotifications(){
    const list = $("notifList");
    list.innerHTML = `<div class="text-center text-gray-400">Loading...</div>`;
    try{
      const qy = query(collection(db,"notifications"), orderBy("createdAt","desc"), limit(20));
      const snap = await getDocs(qy);
      if(snap.empty){
        list.innerHTML = `<div class="text-center text-gray-400">No new notifications.</div>`;
        return;
      }
      list.innerHTML="";
      snap.forEach(d=>{
        const n=d.data();
        const dt = n.createdAt?.seconds ? new Date(n.createdAt.seconds*1000).toLocaleString() : "N/A";
        const card = document.createElement("div");
        card.className="card p-4";
        card.innerHTML = `
          <p class="font-semibold mb-1">${n.title||"Notice"}</p>
          <p class="text-sm text-gray-300">${n.message||""}</p>
          <p class="text-[11px] text-gray-500 mt-2">${dt}</p>
        `;
        list.appendChild(card);
      });
    }catch(e){
      console.error(e);
      list.innerHTML = `<div class="text-center text-rose-400">Failed to load notifications.</div>`;
    }
  }

  // Simple text helper
  const fmt = (n)=> (Number(n)||0).toFixed(2);
</script>
</body>
</html>