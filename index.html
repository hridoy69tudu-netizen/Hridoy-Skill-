<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Swap4Cash</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // আপনার Firebase কনফিগারেশন
        const firebaseConfig = {
            apiKey: "AIzaSyCoKBX6p2zsmWq47NXQvgArVXjB4Xu_63g",
            authDomain: "hridoy-8d6c1.firebaseapp.com",
            projectId: "hridoy-8d6c1",
            storageBucket: "hridoy-8d6c1.firebasestorage.app",
            messagingSenderId: "953393602911",
            appId: "1:953393602911:web:6685a090899597a9d916ea",
            measurementId: "G-KP6J8E6W80"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // কাস্টম অ্যালার্ট ফাংশন
        window.showAlert = function(message) {
            const modal = document.getElementById('custom-alert-modal');
            const msgElement = document.getElementById('custom-alert-message');
            msgElement.innerText = message;
            modal.style.display = 'flex';
        };

        window.closeAlert = function() {
            const modal = document.getElementById('custom-alert-modal');
            modal.style.display = 'none';
        };

        let currentUserId = null;

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('main-content-container').style.display = 'block';
                loadUserData(user.uid);
                loadTasks();
            } else {
                document.getElementById('main-content-container').innerHTML = '<h2>Please log in to view your dashboard.</h2>';
                // window.location.href = "login.html"; // লগইন পেইজে রিডাইরেক্ট করতে পারেন
            }
        });

        window.handleLogout = async function() {
            await signOut(auth);
            window.location.href = "index.html"; // ল্যান্ডিং পেইজে রিডাইরেক্ট করা
        };

        function loadUserData(userId) {
            onSnapshot(doc(db, "users", userId), (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    document.getElementById('user-balance').innerText = `$${userData.balance.toFixed(2)}`;
                    document.getElementById('user-ads-watched').innerText = userData.adsWatched || 0;
                }
            });
        }

        function loadTasks() {
            const tasksList = document.getElementById('tasks-list');
            onSnapshot(collection(db, "tasks"), (querySnapshot) => {
                tasksList.innerHTML = '';
                if (querySnapshot.empty) {
                    tasksList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No tasks available right now. Check back later!</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const task = doc.data();
                    const taskItem = document.createElement('div');
                    taskItem.classList.add('task-item');
                    taskItem.innerHTML = `
                        <h3>${task.title}</h3>
                        <p>${task.description}</p>
                        <div class="task-earning">
                            <span>Earning:</span>
                            <span class="earning-value">$${task.earning.toFixed(2)}</span>
                        </div>
                        <button class="complete-task-btn" data-task-id="${doc.id}" data-earning="${task.earning}">Complete Task</button>
                    `;
                    tasksList.appendChild(taskItem);
                });
            });
        }
        
        window.handleWithdrawal = async function() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const method = document.getElementById('withdrawal-method').value;
            const account = document.getElementById('withdrawal-account').value;
            const user = auth.currentUser;

            if (!user) {
                showAlert("Please log in to make a withdrawal request.");
                return;
            }

            if (amount <= 0 || !method || !account) {
                showAlert("Please fill in all withdrawal details.");
                return;
            }

            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists() || userDoc.data().balance < amount) {
                    showAlert("Insufficient balance for this withdrawal.");
                    return;
                }
                
                await addDoc(collection(db, "withdrawal_requests"), {
                    userId: user.uid,
                    amount: amount,
                    method: method,
                    account: account,
                    status: 'pending',
                    timestamp: new Date()
                });

                await updateDoc(doc(db, "users", user.uid), {
                    balance: increment(-amount)
                });
                
                showAlert("Withdrawal request submitted successfully! Your request is pending.");
                document.getElementById('withdrawal-amount').value = '';
                document.getElementById('withdrawal-account').value = '';

            } catch (error) {
                console.error("Error submitting withdrawal request:", error);
                showAlert("Failed to submit withdrawal request. Please try again.");
            }
        };

        window.handleTaskCompletion = async function(taskId, earning) {
            if (!currentUserId) {
                showAlert("Please log in to complete tasks.");
                return;
            }

            try {
                const userDocRef = doc(db, "users", currentUserId);
                
                await updateDoc(userDocRef, {
                    balance: increment(earning),
                    adsWatched: increment(1)
                });

                showAlert(`Task completed successfully! Earned $${earning.toFixed(2)}.`);
            } catch (error) {
                console.error("Error completing task:", error);
                showAlert("Failed to complete task. Please try again.");
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.tab-item');
            const sections = document.querySelectorAll('.content-section');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const target = tab.getAttribute('data-tab');
                    sections.forEach(s => {
                        s.classList.remove('active');
                        if (s.id === target) {
                            s.classList.add('active');
                        }
                    });
                });
            });

            document.getElementById('tasks-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('complete-task-btn')) {
                    const taskId = e.target.dataset.taskId;
                    const earning = parseFloat(e.target.dataset.earning);
                    handleTaskCompletion(taskId, earning);
                }
            });
        });

    </script>
    <style>
        body {
            background-color: #1a202c;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        .header {
            background-color: #2d3748;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #4CAF50;
            position: relative;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
            color: #e0e0e0;
        }
        .logout-btn {
            background-color: #e65100;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-size: 0.9em;
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
        }
        .tabs {
            display: flex;
            justify-content: center;
            background-color: #1a202c;
            border-bottom: 1px solid #4a5568;
        }
        .tab-item {
            padding: 15px 30px;
            cursor: pointer;
            color: #a0aec0;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .tab-item:hover, .tab-item.active {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        .main-container {
            padding: 20px;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .dashboard-card {
            background-color: #2d3748;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .dashboard-card h2 {
            font-size: 1.5em;
            margin-top: 0;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #4CAF50;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .info-item {
            background-color: #1a202c;
            padding: 15px;
            border-radius: 8px;
        }
        .info-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2196F3;
        }
        .withdrawal-form label, .withdrawal-form input, .withdrawal-form select {
            display: block;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        .withdrawal-form input, .withdrawal-form select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #4a5568;
            background-color: #1a202c;
            color: #e0e0e0;
        }
        .withdrawal-form button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .tasks-list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .task-item {
            background-color: #1a202c;
            padding: 15px;
            border-radius: 8px;
        }
        .task-item h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .task-earning {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .complete-task-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-size: 1em;
        }
        /* কাস্টম অ্যালার্ট স্টাইল */
        #custom-alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .custom-alert-content {
            background-color: #2d3748;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-width: 350px;
            width: 90%;
        }
        .custom-alert-content h3 {
            margin-top: 0;
            color: #e0e0e0;
        }
        .custom-alert-content p {
            margin: 15px 0;
            color: #cbd5e0;
        }
        .custom-alert-content button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div id="main-content-container">
        <div class="header">
            <h1>User Dashboard</h1>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <div class="tabs">
            <div class="tab-item active" data-tab="dashboard-section">Dashboard</div>
            <div class="tab-item" data-tab="tasks-section">Tasks</div>
            <div class="tab-item" data-tab="withdraw-section">Withdraw</div>
        </div>

        <div class="main-container">
            <div id="dashboard-section" class="content-section active">
                <div class="dashboard-card">
                    <h2>Account Overview</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="value" id="user-balance">$0.00</div>
                            <div class="label">Total Balance</div>
                        </div>
                        <div class="info-item">
                            <div class="value" id="user-ads-watched">0</div>
                            <div class="label">Ads Watched</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="tasks-section" class="content-section">
                <div class="dashboard-card">
                    <h2>Available Tasks</h2>
                    <div class="tasks-list-container" id="tasks-list">
                        <p style="text-align: center; color: #a0aec0;">Loading tasks...</p>
                    </div>
                </div>
            </div>

            <div id="withdraw-section" class="content-section">
                <div class="dashboard-card">
                    <h2>Request Withdrawal</h2>
                    <form class="withdrawal-form" onsubmit="return false;">
                        <label for="withdrawal-amount">Amount ($):</label>
                        <input type="number" id="withdrawal-amount" placeholder="Enter amount" step="0.01" required>
                        
                        <label for="withdrawal-method">Withdrawal Method:</label>
                        <input type="text" id="withdrawal-method" placeholder="যেমন: Bkash, Nagad" required>
                        
                        <label for="withdrawal-account">Account Number:</label>
                        <input type="text" id="withdrawal-account" placeholder="অ্যাকাউন্ট নম্বর দিন" required>

                        <button onclick="handleWithdrawal()">Submit Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="custom-alert-modal">
        <div class="custom-alert-content">
            <h3>Alert</h3>
            <p id="custom-alert-message"></p>
            <button onclick="closeAlert()">OK</button>
        </div>
    </div>
</body>
</html>
