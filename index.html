<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashReward App</title>

    <script src='//libtl.com/sdk.js' data-zone='9572158' data-sdk='show_9572158'></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #ffffff; }
        .dark-bg { background-color: #121212; }
        .card-bg { background-color: #1e1e1e; }
        .border-accent { border-color: #ff8c00; }
        .text-accent { color: #ff8c00; }
        .btn, .btn-accent, .btn-outline-accent { transition: all 0.2s ease-in-out; transform: scale(1); }
        .btn:active, .btn-accent:active, .btn-outline-accent:active { transform: scale(0.95); }
        .btn-accent { background-color: #ff8c00; color: #121212; font-weight: bold; }
        .btn-accent:hover { background-color: #e67e00; }
        .btn-outline-accent { border: 1px solid #ff8c00; color: #ff8c00; }
        .btn-outline-accent:hover { background-color: #ff8c00; color: #121212; }
        .input-field { background-color: #2c2c2c; border: 1px solid #444; }
        .user-page { display: none; }
        .user-page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        .sidebar { background-color: #1e1e1e; }
        .sidebar-link { transition: background-color 0.2s; }
        .sidebar-link.active { background-color: #2c2c2c; }
        .progress-bar-container { background-color: #2c2c2c; border-radius: 9999px; height: 8px; overflow: hidden; }
        .progress-bar { background-color: #ff8c00; height: 100%; transition: width 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="loader" class="hidden fixed inset-0 dark-bg bg-opacity-75 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-accent"></div>
</div>

<div id="login-section" class="min-h-screen p-6 flex-col justify-center items-center">
    <div class="max-w-md w-full mx-auto">
        <h1 class="text-4xl font-bold text-center mb-2 text-accent">Welcome</h1>
        <p class="text-center text-gray-400 mb-8">Login or Register</p>
        <div class="card-bg p-6 rounded-lg">
            <input id="login-email" type="email" placeholder="Email" class="w-full p-3 rounded-lg input-field mb-4">
            <input id="login-password" type="password" placeholder="Password" class="w-full p-3 rounded-lg input-field mb-4">
            <input id="register-name" type="text" placeholder="Full Name (for new users)" class="w-full p-3 rounded-lg input-field mb-4">
            <button id="login-btn" class="w-full p-3 rounded-lg btn-accent mb-4">Login</button>
            <button id="register-btn" class="w-full p-3 rounded-lg btn-outline-accent">Register</button>
        </div>
    </div>
</div>

<div id="user-panel-container" class="hidden min-h-screen flex flex-col md:flex-row">
    <aside class="sidebar w-full md:w-64 p-4 md:h-screen md:sticky top-0 z-20">
        <div class="flex items-center space-x-2 mb-6">
            <i data-lucide="user" class="w-6 h-6 text-accent"></i>
            <h1 id="user-name" class="text-xl font-bold"></h1>
        </div>
        <nav class="space-y-2">
            <a href="#" class="sidebar-link block p-3 rounded-lg flex items-center space-x-2 active" data-page="home-page"><i data-lucide="home" class="w-5 h-5"></i><span>Home</span></a>
            <a href="#" class="sidebar-link block p-3 rounded-lg flex items-center space-x-2" data-page="tasks-page"><i data-lucide="list-checks" class="w-5 h-5"></i><span>Tasks</span></a>
            <a href="#" class="sidebar-link block p-3 rounded-lg flex items-center space-x-2" data-page="withdraw-page"><i data-lucide="wallet" class="w-5 h-5"></i><span>Withdraw</span></a>
            <a href="#" class="sidebar-link block p-3 rounded-lg flex items-center space-x-2" data-page="refer-page"><i data-lucide="users" class="w-5 h-5"></i><span>Refer & Earn</span></a>
            <a href="#" class="sidebar-link block p-3 rounded-lg flex items-center space-x-2" data-page="history-page"><i data-lucide="history" class="w-5 h-5"></i><span>History</span></a>
        </nav>
        <button id="logout-btn" class="w-full mt-6 p-3 rounded-lg bg-red-600 text-white font-bold">Logout</button>
    </aside>

    <main class="flex-grow p-6 overflow-y-auto">
        <div id="home-page" class="user-page active">
            <h2 class="text-3xl font-bold mb-6">Your Dashboard</h2>
            <div class="card-bg p-6 rounded-lg text-center mb-6">
                <h3 class="text-gray-400 font-semibold mb-2">Current Balance</h3>
                <p id="user-balance" class="text-6xl font-bold text-accent">0</p>
                <p class="text-gray-400">Coins</p>
            </div>
            <div class="card-bg p-6 rounded-lg text-center">
                <h3 class="text-gray-400 font-semibold mb-2">Daily Ad Watch</h3>
                <p id="ad-count-display" class="text-2xl font-bold text-accent mb-2">0/0</p>
                <div class="progress-bar-container mb-4">
                    <div id="ad-progress-bar" class="progress-bar" style="width: 0%;"></div>
                </div>
                <button id="watch-ad-btn" class="btn-accent px-6 py-2 rounded-lg" onclick="handleAdWatch()">Watch Ad</button>
            </div>
        </div>

        <div id="tasks-page" class="user-page">
            <h2 class="text-3xl font-bold mb-6">Tasks</h2>
            <p class="text-gray-400">Complete tasks to earn more coins.</p>
            <div id="tasks-list" class="space-y-4 mt-4">
                <div class="card-bg p-4 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold">Watch Video Ad</p>
                        <p class="text-sm text-gray-400">Earn 10 coins per ad view.</p>
                    </div>
                    <button class="btn-accent px-4 py-1 rounded-lg text-sm" onclick="handleAdWatch('interstitial')">Watch Ad</button>
                </div>
            </div>
        </div>

        <div id="withdraw-page" class="user-page">
            <h2 class="text-3xl font-bold mb-6">Withdraw Coins</h2>
            <div class="card-bg p-6 rounded-lg">
                <p id="min-withdrawal-text" class="text-center text-gray-400 mb-4"></p>
                <label for="withdrawal-method" class="block text-sm font-medium mb-2">Withdrawal Method</label>
                <select id="withdrawal-method" class="w-full p-3 rounded-lg input-field mb-4"></select>
                <label for="withdrawal-amount" class="block text-sm font-medium mb-2">Amount (Coins)</label>
                <input id="withdrawal-amount" type="number" placeholder="Enter amount" class="w-full p-3 rounded-lg input-field mb-4">
                <label for="payment-detail" class="block text-sm font-medium mb-2">Payment Detail (e.g. Phone Number)</label>
                <input id="payment-detail" type="text" placeholder="Enter payment detail" class="w-full p-3 rounded-lg input-field mb-4">
                <button id="withdraw-btn" class="w-full p-3 rounded-lg btn-accent">Request Withdrawal</button>
            </div>
        </div>

        <div id="refer-page" class="user-page">
            <h2 class="text-3xl font-bold mb-6">Refer & Earn</h2>
            <div class="card-bg p-6 rounded-lg text-center">
                <p class="text-gray-400 mb-4">Share your referral code to invite friends and earn coins.</p>
                <p id="referral-code" class="text-4xl font-bold text-accent mb-4"></p>
                <button id="copy-referral-btn" class="btn-accent px-6 py-2 rounded-lg">Copy Code</button>
            </div>
        </div>

        <div id="history-page" class="user-page">
            <h2 class="text-3xl font-bold mb-6">Transaction History</h2>
            <div id="history-list" class="space-y-4"></div>
        </div>
    </main>
</div>

<div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center">
        <p id="alert-message" class="mb-4"></p>
        <button id="alert-ok-btn" class="btn-accent px-6 py-2 rounded-lg">OK</button>
    </div>
</div>

<script type="module">
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAuRjoQd88a3sRaU-mZyogapNCjgDbc4R8",
      authDomain: "hridoy-skill-1.firebaseapp.com",
      databaseURL: "https://hridoy-skill-1-default-rtdb.firebaseio.com",
      projectId: "hridoy-skill-1",
      storageBucket: "hridoy-skill-1.firebasestorage.app",
      messagingSenderId: "840073498608",
      appId: "1:840073498608:web:4741e43ca186e027a95735",
      measurementId: "G-YG5H5ZFBR8"
    };

    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userData = null;
    let appConfig = null;
    const today = new Date().toISOString().slice(0, 10);

    // DOM Elements
    const loader = document.getElementById('loader');
    const loginSection = document.getElementById('login-section');
    const userPanelContainer = document.getElementById('user-panel-container');
    const userBalanceEl = document.getElementById('user-balance');
    const adCountDisplay = document.getElementById('ad-count-display');
    const adProgressBar = document.getElementById('ad-progress-bar');
    const userNameEl = document.getElementById('user-name');
    const referralCodeEl = document.getElementById('referral-code');
    const historyListEl = document.getElementById('history-list');
    const withdrawalMethodSelect = document.getElementById('withdrawal-method');
    const minWithdrawalTextEl = document.getElementById('min-withdrawal-text');
    const registerNameInput = document.getElementById('register-name');

    // On Load & Auth State Change
    window.onload = () => {
        lucide.createIcons();
        setupEventListeners();
        onAuthStateChanged(auth, handleAuthStateChange);
    };

    async function handleAuthStateChange(user) {
        if (user) {
            loader.style.display = 'flex';
            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    userData = userDoc.data();
                    const configDocRef = doc(db, "config", "main");
                    const configDoc = await getDoc(configDocRef);
                    appConfig = configDoc.exists() ? configDoc.data() : null;

                    if (userData.isBlocked) {
                        showAlert("Your account has been blocked.");
                        await signOut(auth);
                        return;
                    }

                    loginSection.classList.add('hidden');
                    userPanelContainer.classList.remove('hidden');
                    updateUI();
                    loadHistory();
                    loadWithdrawalMethods();
                } else {
                    // This case should not be hit with the new logic, but kept as a fallback
                    showAlert("User data not found. Please try logging in again.");
                    await signOut(auth);
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showAlert("Error loading user data.");
            } finally {
                loader.style.display = 'none';
            }
        } else {
            loginSection.classList.remove('hidden');
            userPanelContainer.classList.add('hidden');
        }
        loader.style.display = 'none';
    }

    // Auth Functions
    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        if (!email || !password) {
            return showAlert("Please enter both email and password.");
        }
        loader.style.display = 'flex';
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            showAlert("Login failed: " + error.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    async function handleRegister() {
        const name = registerNameInput.value;
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!name || !email || !password) {
            return showAlert("Please fill in all fields (Full Name, Email, Password).");
        }
        loader.style.display = 'flex';
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            await setDoc(doc(db, "users", user.uid), {
                uid: user.uid,
                email: email,
                name: name,
                balance: 0,
                dailyAdCount: 0,
                lastAdWatchDate: '',
                isBlocked: false,
                createdAt: serverTimestamp()
            });
            showAlert("Registration successful! Welcome.");
        } catch (error) {
            showAlert("Registration failed: " + error.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    async function handleLogout() {
        await signOut(auth);
    }

    // UI Updates
    function updateUI() {
        if (!userData || !appConfig) return;

        userNameEl.textContent = userData.name || userData.email;
        userBalanceEl.textContent = userData.balance || 0;
        referralCodeEl.textContent = userData.uid.slice(0, 10);
        minWithdrawalTextEl.textContent = `Minimum withdrawal amount: ${appConfig.minWithdrawal || 0} coins`;

        const dailyLimit = appConfig.dailyAdLimit || 0;
        const currentCount = userData.lastAdWatchDate === today ? userData.dailyAdCount : 0;
        adCountDisplay.textContent = `${currentCount}/${dailyLimit}`;
        const progress = dailyLimit > 0 ? (currentCount / dailyLimit) * 100 : 0;
        adProgressBar.style.width = `${progress}%`;
        document.getElementById('watch-ad-btn').disabled = currentCount >= dailyLimit;
    }

    // Tasks & Ads
    async function handleAdWatch() {
        if (!userData || !appConfig) {
            return showAlert("Ad not available. Please try again later.");
        }
        
        loader.style.display = 'flex';
        
        const dailyLimit = appConfig.dailyAdLimit || 0;
        if (userData.lastAdWatchDate !== today) {
            // Reset daily count if it's a new day
            userData.dailyAdCount = 0;
            const userRef = doc(db, "users", userData.uid);
            await updateDoc(userRef, { dailyAdCount: 0, lastAdWatchDate: today });
        }

        if ((userData.dailyAdCount || 0) >= dailyLimit) {
            showAlert("You have reached the daily ad limit.");
            loader.style.display = 'none';
            return;
        }

        try {
            await window.show_9572158(); // Show the ad
            const rewardAmount = appConfig.rewards.interstitial || 0;
            const userRef = doc(db, "users", userData.uid);
            const newAdCount = (userData.dailyAdCount || 0) + 1;
            
            await updateDoc(userRef, { 
                balance: (userData.balance || 0) + rewardAmount,
                dailyAdCount: newAdCount,
                lastAdWatchDate: today
            });

            userData.balance += rewardAmount;
            userData.dailyAdCount = newAdCount;
            userData.lastAdWatchDate = today;

            updateUI();
            showAlert(`Congratulations! You have won ${rewardAmount} coins.`);
        } catch(e) {
            console.error("Ad or database update error:", e);
            showAlert('Could not show ad or update your balance. Please try again later.');
        } finally {
            loader.style.display = 'none';
        }
    }

    // Withdrawals
    async function handleWithdrawal() {
        const amount = parseInt(document.getElementById('withdrawal-amount').value);
        const method = withdrawalMethodSelect.value;
        const detail = document.getElementById('payment-detail').value;

        if (isNaN(amount) || amount <= 0 || !method || !detail) {
            return showAlert("Please fill in all withdrawal details correctly.");
        }
        if (amount > userData.balance) {
            return showAlert("You do not have enough coins.");
        }
        if (amount < appConfig.minWithdrawal) {
            return showAlert(`The minimum withdrawal amount is ${appConfig.minWithdrawal} coins.`);
        }

        loader.style.display = 'flex';
        try {
            const userRef = doc(db, "users", userData.uid);
            await updateDoc(userRef, { balance: userData.balance - amount });

            const withdrawalsRef = collection(db, "withdrawals");
            await addDoc(withdrawalsRef, {
                userId: userData.uid,
                userName: userData.name,
                userEmail: userData.email,
                amount: amount,
                method: method,
                paymentDetail: detail,
                status: 'pending',
                requestedAt: serverTimestamp()
            });

            userData.balance -= amount;
            updateUI();
            showAlert("Withdrawal request submitted successfully!");
        } catch (error) {
            console.error("Error submitting withdrawal:", error);
            showAlert("Failed to submit withdrawal request.");
        } finally {
            loader.style.display = 'none';
        }
    }

    async function loadWithdrawalMethods() {
        if (!appConfig || !appConfig.paymentMethods) return;
        withdrawalMethodSelect.innerHTML = '';
        appConfig.paymentMethods.forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            withdrawalMethodSelect.appendChild(option);
        });
    }

    // History
    async function loadHistory() {
        if (!userData) return;
        historyListEl.innerHTML = '<p class="text-gray-400 text-center">Loading history...</p>';
        try {
            const q = query(collection(db, "withdrawals"), where("userId", "==", userData.uid), orderBy("requestedAt", "desc"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                historyListEl.innerHTML = '<p class="text-gray-400 text-center">No withdrawal history found.</p>';
                return;
            }

            historyListEl.innerHTML = '';
            querySnapshot.forEach(doc => {
                const req = doc.data();
                const date = req.requestedAt ? new Date(req.requestedAt.seconds * 1000).toLocaleString() : 'N/A';
                const statusColor = req.status === 'pending' ? 'text-yellow-400' : (req.status === 'approved' ? 'text-green-400' : 'text-red-400');
                historyListEl.innerHTML += `<div class="card-bg p-4 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold">${req.amount} Coins</p>
                        <p class="text-sm text-gray-400">Via ${req.method}</p>
                        <p class="text-xs text-gray-500">${date}</p>
                    </div>
                    <span class="${statusColor} font-semibold capitalize">${req.status}</span>
                </div>`;
            });
        } catch (error) {
            console.error("Error loading history:", error);
            historyListEl.innerHTML = '<p class="text-red-400 text-center">Error loading history.</p>';
        }
    }
    
    // Navigation & UI
    function navigateTo(pageId) {
        document.querySelectorAll('.user-page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.page === pageId) link.classList.add('active');
        });
    }

    function setupEventListeners() {
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('register-btn').addEventListener('click', handleRegister);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('watch-ad-btn').addEventListener('click', handleAdWatch);
        document.getElementById('withdraw-btn').addEventListener('click', handleWithdrawal);
        document.getElementById('copy-referral-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(referralCodeEl.textContent);
            showAlert("Referral code copied to clipboard!");
        });
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(e.currentTarget.dataset.page);
            });
        });
    }
    
    // Utility Alert
    function showAlert(message) {
        document.getElementById('alert-message').textContent = message;
        document.getElementById('custom-alert').classList.remove('hidden');
        document.getElementById('alert-ok-btn').onclick = () => {
            document.getElementById('custom-alert').classList.add('hidden');
        };
    }
    window.showAlert = showAlert;

</script>
</body>
</html>
